const dataFile="/data/database/questions.json";let allQuestions=[],dataLoaded=!1;const searchInput=document.getElementById("searchInput"),resultsDiv=document.getElementById("results"),searchInfoDiv=document.getElementById("searchInfo"),resultCountDiv=document.querySelector(".result-count"),searchQuestionCheckbox=document.getElementById("searchQuestion"),searchOptionsCheckbox=document.getElementById("searchOptions"),themeToggle=document.getElementById("themeToggle"),themeIcon=document.getElementById("themeIcon"),textFieldElement=document.querySelector(".mdc-text-field"),textField=textFieldElement?new mdc.textField.MDCTextField(textFieldElement):null;let currentSearchTerm="";const settingsButton=document.getElementById("settingsButton"),settingsPanel=document.getElementById("settingsPanel"),searchContainer=document.querySelector(".search-container"),fuzzyKeywordsContainer=document.getElementById("fuzzyKeywordsContainer"),trickyWordsContainer=document.getElementById("trickyWordsContainer"),addFuzzyBtn=document.getElementById("addFuzzyBtn"),addTrickyBtn=document.getElementById("addTrickyBtn"),applySettingsBtn=document.getElementById("applySettingsBtn"),defaultSettings={fuzzy_keywords:{bl:"bootloader",fb:"fastboot",rec:"recovery",rom:"刷机包"},tricky_words:["不正确","不包括","错误的是","错误选项","错误的是","不是以下哪项","不能"]};let debounceTimer,currentSettings={...defaultSettings};async function loadAllData(){if(!dataLoaded)try{const e=await fetch(dataFile);if(!e.ok)throw new Error("加载失败");const t=await e.json();allQuestions=t.map((e,t)=>({...e,originalIndex:t+1})),dataLoaded=!0}catch(e){console.warn(`无法加载 ${dataFile}`,e),resultsDiv.innerHTML='<p class="mdc-typography--body1" style="text-align: center; padding: 16px;">加载题库数据失败，请检查文件是否存在或网络连接。</p>',allQuestions=[]}}function matchQuery(e,t){if(!(t=t.trim().toLowerCase()))return!1;const n=searchQuestionCheckbox.checked,s=searchOptionsCheckbox.checked;if(!n&&!s)return!1;const o=t.split(/\s+/).filter(e=>e.length>0),i=[];return o.forEach(e=>{const t=[e];currentSettings.fuzzy_keywords[e]&&t.push(currentSettings.fuzzy_keywords[e].toLowerCase()),i.push(t)}),i.every(t=>{let o=!1;if(n){const n=e.question.toLowerCase();o=t.some(e=>n.includes(e))}return s&&!o&&(o=e.options.some(e=>t.some(t=>e.option.toLowerCase().includes(t)))),o})}function highlightText(e,t){if(!t)return highlightTrickyWords(e);const n=new RegExp(`(${t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");let s=e.replace(n,'<span class="highlight">$1</span>');return s=highlightTrickyWords(s),s}function highlightTrickyWords(e){let t=e;return currentSettings.tricky_words.forEach(e=>{if(e.trim()){const n=new RegExp(`(${e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");t=t.replace(n,'<span class="tricky-highlight">$1</span>')}}),t}function renderResults(e){if(resultsDiv.innerHTML="",0===e.length)return searchInfoDiv.style.display="none",void(resultsDiv.innerHTML='<p class="mdc-typography--body1" style="text-align: center; padding: 16px;">未找到相关题目。</p>');const t=mergeQuestionsByTitle(e);resultCountDiv.textContent=currentSearchTerm?`${t.length} 个结果，合并前 ${e.length} 个题目`:`共 ${t.length} 道题目，合并前 ${e.length} 个题目`,searchInfoDiv.style.display="block";const n=document.createElement("ul");n.className="mdc-list mdc-list--two-line";for(const e of t){const t=document.createElement("li");t.className="mdc-list-item question-item";const s=document.createElement("span");s.className="mdc-list-item__ripple",t.appendChild(s);const o=document.createElement("span");o.className="mdc-list-item__text";const i=document.createElement("span");i.className="mdc-list-item__primary-text question-title";const a=document.createElement("span");a.className="question-number clickable",a.textContent=e.originalIndex,a.style.cursor="pointer",a.addEventListener("click",t=>{t.stopPropagation(),showQuestionModal(e)});const r=document.createElement("span");r.innerHTML=highlightText(e.question,currentSearchTerm),i.appendChild(a),i.appendChild(r),o.appendChild(i);const c=document.createElement("ul");c.className="options-list mdc-list-item__secondary-text";const l=[...e.options].sort((e,t)=>{const n="true"===e.is_correct,s="true"===t.is_correct;return n&&!s?-1:!n&&s?1:0});for(const e of l){const t=document.createElement("li");t.innerHTML=highlightText(e.option,currentSearchTerm),t.className="true"===e.is_correct?"correct":"incorrect",c.appendChild(t)}o.appendChild(c),t.appendChild(o),n.appendChild(t)}resultsDiv.appendChild(n)}function mergeQuestionsByTitle(e){const t=new Map;for(const n of e){const e=n.question.trim();if(t.has(e)){const s=t.get(e);for(const e of n.options){s.options.some(t=>t.option.trim()===e.option.trim())||s.options.push(e)}s.originalIndex=Math.min(s.originalIndex,n.originalIndex)}else t.set(e,{question:n.question,options:[...n.options],originalIndex:n.originalIndex})}return Array.from(t.values())}function performSearch(){const e=searchInput.value.trim();if(currentSearchTerm=e,dataLoaded){let t;t=e?allQuestions.filter(t=>t.question&&matchQuery(t,e)):allQuestions.filter(e=>e.question),t.sort((e,t)=>e.originalIndex-t.originalIndex),renderResults(t)}else resultsDiv.innerHTML="加载数据中...",loadAllData().then(()=>{let t;t=e?allQuestions.filter(t=>t.question&&matchQuery(t,e)):allQuestions.filter(e=>e.question),t.sort((e,t)=>e.originalIndex-t.originalIndex),renderResults(t)})}function initializeSearchListeners(){searchQuestionCheckbox&&searchQuestionCheckbox.addEventListener("change",performSearch),searchOptionsCheckbox&&searchOptionsCheckbox.addEventListener("change",performSearch),searchInput&&searchInput.addEventListener("input",async e=>{clearTimeout(debounceTimer),debounceTimer=setTimeout(performSearch,200)})}function loadSettings(){const e=localStorage.getItem("searchSettings");if(e)try{const t=JSON.parse(e);currentSettings={fuzzy_keywords:{...defaultSettings.fuzzy_keywords,...t.fuzzy_keywords&&Object.keys(t.fuzzy_keywords).length>0?t.fuzzy_keywords:{}},tricky_words:t.tricky_words&&Array.isArray(t.tricky_words)&&t.tricky_words.length>0?t.tricky_words:defaultSettings.tricky_words}}catch(e){console.warn("加载设置失败，使用默认设置",e),currentSettings={...defaultSettings},localStorage.removeItem("searchSettings")}else currentSettings={...defaultSettings}}function saveSettings(){localStorage.setItem("searchSettings",JSON.stringify(currentSettings))}function getStarredQuestions(){const e=localStorage.getItem("starredQuestions");return e?JSON.parse(e):{}}function saveStarredQuestions(e){localStorage.setItem("starredQuestions",JSON.stringify(e))}function isQuestionStarred(e){return getStarredQuestions().hasOwnProperty(e)}function toggleStar(e,t){const n=getStarredQuestions();n[e]?delete n[e]:n[e]={question:t.question,options:t.options,originalIndex:t.originalIndex,starredAt:(new Date).toISOString()},saveStarredQuestions(n)}function updateStarButton(e,t){isQuestionStarred(t)?(e.classList.add("starred"),e.innerHTML='<span class="material-icons">star</span>',e.title="取消收藏"):(e.classList.remove("starred"),e.innerHTML='<span class="material-icons">star_border</span>',e.title="收藏题目")}function showQuestionModal(e){const t=document.createElement("div");t.className="question-modal-overlay";const n=document.createElement("div");n.className="question-modal-card";const s=document.createElement("div");s.className="question-modal-content";const o=document.createElement("div");o.className="question-modal-header",o.innerHTML=`\n        <span class="question-modal-number">${e.originalIndex}</span>\n        <div class="question-modal-text">${e.question}</div>\n    `;const i=document.createElement("div");i.className="question-modal-options",e.options.forEach(e=>{const t=document.createElement("div");t.className="question-modal-option "+("true"===e.is_correct?"correct":"incorrect"),t.textContent=e.option,i.appendChild(t)});const a=document.createElement("div");a.className="question-modal-actions";const r=document.createElement("button");r.className="modal-action-btn star-action";const c=isQuestionStarred(e.originalIndex);r.innerHTML=`\n        <span class="material-icons">${c?"star":"star_border"}</span>\n        <span>${c?"取消":"收藏"}</span>\n    `,c&&r.classList.add("starred"),r.addEventListener("click",()=>{toggleStar(e.originalIndex,e);const t=isQuestionStarred(e.originalIndex);r.innerHTML=`\n            <span class="material-icons">${t?"star":"star_border"}</span>\n            <span>${t?"取消":"收藏"}</span>\n        `,t?r.classList.add("starred"):r.classList.remove("starred")});const l=document.createElement("button");l.className="modal-action-btn copy-action",l.innerHTML='\n        <span class="material-icons">content_copy</span>\n        <span>复制</span>\n    ',l.addEventListener("click",async()=>{try{let t="我在「答题助手」给你分享了一道题目，快打开 bl.lh520.pw 看看吧！\n";t+=`${e.originalIndex}、${e.question}\n`;[...e.options].sort((e,t)=>{const n="true"===e.is_correct,s="true"===t.is_correct;return n&&!s?-1:!n&&s?1:0}).forEach(e=>{const n="true"===e.is_correct?"正确":"错误";t+=`[${n}] ${e.option}\n`}),await navigator.clipboard.writeText(t),l.innerHTML='\n                <span class="material-icons">check</span>\n                <span>成功</span>\n            ',l.style.borderColor="#4caf50",l.style.color="#4caf50",setTimeout(()=>{l.innerHTML='\n                    <span class="material-icons">content_copy</span>\n                    <span>复制</span>\n                ',l.style.borderColor="",l.style.color=""},2e3)}catch(e){console.error("复制失败:",e),l.innerHTML='\n                <span class="material-icons">error</span>\n                <span>失败</span>\n            ',l.style.borderColor="#f44336",l.style.color="#f44336",setTimeout(()=>{l.innerHTML='\n                    <span class="material-icons">content_copy</span>\n                    <span>复制</span>\n                ',l.style.borderColor="",l.style.color=""},2e3)}});const d=document.createElement("button");d.className="modal-action-btn question-action",d.innerHTML='\n        <span class="material-icons">help_outline</span>\n        <span>疑问</span>\n    ',d.addEventListener("click",()=>{if(confirm("即将跳转到 GitHub 仓库发起工单反馈问题。\n\n您可以在那里报告题目错误、提出改进建议或反馈其他问题。\n\n确定要继续吗？")){const t=`https://github.com/YuleBest/xiaomi-bl-unlock-helper/issues/new?title=${encodeURIComponent(`题目疑问 - 第${e.originalIndex}题`)}&body=${encodeURIComponent(`### 题目信息\n**题号：** ${e.originalIndex}\n**题目：** ${e.question}\n\n### 问题描述\n请在此处描述您发现的问题或疑问...\n\n### 建议的修改\n如果您有修改建议，请在此处说明...\n\n---\n*此工单由答题助手自动生成*`)}`;window.open(t,"_blank"),d.innerHTML='\n                <span class="material-icons">launch</span>\n                <span>已跳转</span>\n            ',d.style.borderColor="#4caf50",d.style.color="#4caf50",setTimeout(()=>{d.innerHTML='\n                    <span class="material-icons">help_outline</span>\n                    <span>疑问</span>\n                ',d.style.borderColor="",d.style.color=""},2e3)}}),a.appendChild(r),a.appendChild(l),a.appendChild(d),s.appendChild(o),s.appendChild(i),n.appendChild(s),n.appendChild(a),t.appendChild(n),document.body.appendChild(t),setTimeout(()=>{t.classList.add("show")},10),t.addEventListener("click",e=>{e.target===t&&hideQuestionModal(t)});const u=e=>{"Escape"===e.key&&(hideQuestionModal(t),document.removeEventListener("keydown",u))};document.addEventListener("keydown",u)}function hideQuestionModal(e){e.classList.remove("show"),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300)}function toggleSettingsPanel(){settingsPanel.classList.contains("show")?(settingsPanel.classList.remove("show"),settingsButton.classList.remove("expanded"),searchContainer.classList.remove("expanded"),settingsPanel.style.display="none"):(loadSettingsUI(),settingsPanel.style.display="block",setTimeout(()=>{settingsPanel.classList.add("show"),settingsButton.classList.add("expanded"),searchContainer.classList.add("expanded")},10))}function createFuzzyKeywordItem(e="",t=""){const n=document.createElement("div");return n.className="fuzzy-keyword-item",n.innerHTML=`\n        <input type="text" class="keyword-input" placeholder="关键词" value="${e}">\n        <span class="arrow">→</span>\n        <input type="text" class="target-input" placeholder="目标词" value="${t}">\n        <button class="remove-btn" type="button">\n            <i class="material-icons">delete</i>\n        </button>\n    `,n.querySelector(".remove-btn").addEventListener("click",()=>{n.remove()}),n}function createTrickyWordItem(e=""){const t=document.createElement("div");return t.className="tricky-word-item",t.innerHTML=`\n        <input type="text" placeholder="高亮词" value="${e}">\n        <button class="remove-btn" type="button">\n            <i class="material-icons">delete</i>\n        </button>\n    `,t.querySelector(".remove-btn").addEventListener("click",()=>{t.remove()}),t}function loadSettingsUI(){fuzzyKeywordsContainer.innerHTML="",trickyWordsContainer.innerHTML="",Object.entries(currentSettings.fuzzy_keywords).forEach(([e,t])=>{fuzzyKeywordsContainer.appendChild(createFuzzyKeywordItem(e,t))}),currentSettings.tricky_words.forEach(e=>{trickyWordsContainer.appendChild(createTrickyWordItem(e))})}function applySettings(){const e={};fuzzyKeywordsContainer.querySelectorAll(".fuzzy-keyword-item").forEach(t=>{const n=t.querySelector(".keyword-input").value.trim(),s=t.querySelector(".target-input").value.trim();n&&s&&(e[n.toLowerCase()]=s)});const t=[];trickyWordsContainer.querySelectorAll(".tricky-word-item").forEach(e=>{const n=e.querySelector("input").value.trim();n&&t.push(n)}),currentSettings.fuzzy_keywords=e,currentSettings.tricky_words=t,saveSettings(),performSearch();const n=applySettingsBtn.innerHTML;applySettingsBtn.innerHTML='<i class="material-icons">check</i> 已应用',applySettingsBtn.style.background="#4caf50",setTimeout(()=>{applySettingsBtn.innerHTML=n,applySettingsBtn.style.background=""},1500)}let resetConfirmState=!1,resetTimeout=null;function resetSettings(){if(resetConfirmState){resetTimeout&&clearTimeout(resetTimeout),currentSettings={...defaultSettings},saveSettings(),loadSettingsUI(),performSearch(),resetConfirmState=!1;const e=document.getElementById("resetSettingsBtn");e.classList.remove("confirm"),e.innerHTML='<i class="material-icons">check</i> 已重置',e.style.background="#4caf50",setTimeout(()=>{e.innerHTML='<i class="material-icons">refresh</i> 重置设置',e.style.background=""},1500)}else{resetConfirmState=!0;const e=document.getElementById("resetSettingsBtn");e.classList.add("confirm"),e.innerHTML='<i class="material-icons">warning</i> 确认重置',resetTimeout=setTimeout(()=>{resetConfirmState=!1,e.classList.remove("confirm"),e.innerHTML='<i class="material-icons">refresh</i> 重置设置'},5e3)}}settingsButton&&settingsButton.addEventListener("click",toggleSettingsPanel),addFuzzyBtn&&addFuzzyBtn.addEventListener("click",()=>{fuzzyKeywordsContainer.appendChild(createFuzzyKeywordItem())}),addTrickyBtn&&addTrickyBtn.addEventListener("click",()=>{trickyWordsContainer.appendChild(createTrickyWordItem())});const resetSettingsBtn=document.getElementById("resetSettingsBtn");function initializeTheme(){const e=localStorage.getItem("theme");if(e)setTheme(e);else{setTheme(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{localStorage.getItem("theme")||setTheme(e.matches?"dark":"light")})}function setTheme(e){document.documentElement.setAttribute("data-theme",e),themeIcon&&(themeIcon.textContent="dark"===e?"light_mode":"dark_mode"),localStorage.setItem("theme",e)}function toggleTheme(){setTheme("dark"===document.documentElement.getAttribute("data-theme")?"light":"dark")}function showDisclaimerDialog(){const e=document.getElementById("disclaimerDialog"),t=e.querySelector(".disclaimer-dialog-content");e.style.animation="",t.style.animation="",e.style.display="flex",e.style.animation="backgroundFadeIn 0.3s ease-out forwards",t.style.animation="dialogFadeIn 0.3s ease-out forwards"}function hideDisclaimerDialog(){const e=document.getElementById("disclaimerDialog"),t=e.querySelector(".disclaimer-dialog-content");if(!document.getElementById("dialogAnimationStyles")){const e=document.createElement("style");e.id="dialogAnimationStyles",e.textContent="\n            @keyframes backgroundFadeIn {\n                from {\n                    background-color: rgba(0, 0, 0, 0);\n                }\n                to {\n                    background-color: rgba(0, 0, 0, 0.5);\n                }\n            }\n            \n            @keyframes backgroundFadeOut {\n                from {\n                    background-color: rgba(0, 0, 0, 0.5);\n                }\n                to {\n                    background-color: rgba(0, 0, 0, 0);\n                }\n            }\n            \n            @keyframes contentFadeOut {\n                from {\n                    opacity: 1;\n                    transform: scale(1) translateY(0);\n                }\n                to {\n                    opacity: 0;\n                    transform: scale(0.9) translateY(-20px);\n                }\n            }\n        ",document.head.appendChild(e)}e.style.animation="backgroundFadeOut 0.3s ease-in forwards",t.style.animation="contentFadeOut 0.3s ease-in forwards",setTimeout(()=>{e.style.display="none",e.style.animation="",t.style.animation=""},300)}function displayLastUpdateTime(){if(allQuestions&&allQuestions.length>0){const e=allQuestions.find(e=>e.lastestUpdate);if(e&&e.lastestUpdate){const t=document.getElementById("lastUpdateTime");t&&(t.textContent=`题库最后更新于 ${e.lastestUpdate}`)}}}function initializeDisclaimerDialog(){const e=document.querySelector(".disclaimer-banner-content"),t=document.getElementById("closeDisclaimerBtn"),n=document.getElementById("disclaimerDialog");e&&e.addEventListener("click",showDisclaimerDialog),t&&t.addEventListener("click",hideDisclaimerDialog),n&&n.addEventListener("click",function(e){e.target===n&&hideDisclaimerDialog()})}function initializeStarFeature(){const e=document.getElementById("star");e&&e.addEventListener("click",function(){window.location.href="/star/"});const t=document.getElementById("starredEntryBtn");t&&t.addEventListener("click",function(){window.location.href="/star/"})}resetSettingsBtn&&resetSettingsBtn.addEventListener("click",resetSettings),themeToggle&&themeToggle.addEventListener("click",toggleTheme),initializeTheme(),applySettingsBtn&&applySettingsBtn.addEventListener("click",applySettings),document.addEventListener("DOMContentLoaded",async function(){loadSettings(),await loadAllData(),initializeTheme(),initializeSearchListeners(),displayLastUpdateTime(),searchInput&&resultsDiv&&performSearch();const e=document.getElementById("calculatorBtn");e&&e.addEventListener("click",function(){window.location.href="/calc/"});const t=document.getElementById("feedbackBtn");t&&t.addEventListener("click",function(){window.open("https://github.com/YuleBest/xiaomi-bl-unlock-helper/issues","_blank")});const n=document.getElementById("joinDevBtn");n&&n.addEventListener("click",function(){window.open("https://github.com/YuleBest/xiaomi-bl-unlock-helper","_blank")});const s=document.getElementById("downloadDbBtn");s&&s.addEventListener("click",function(){const e=document.createElement("a");e.href="/data/database/questions.json",e.download="questions.json",document.body.appendChild(e),e.click(),document.body.removeChild(e)}),initializeDisclaimerDialog(),initializeStarFeature();const o=document.querySelector(".top-bar-left");o&&(o.style.cursor="pointer",o.addEventListener("click",function(){"/"!==window.location.pathname&&"/index.html"!==window.location.pathname&&(window.location.href="/")}))});