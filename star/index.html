<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="/favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>收藏的题目 - 题库搜索</title>
    <link rel="stylesheet" href="/style/material-components-web.min.css">
    <link rel="stylesheet" href="/style/main.css" />
    <script src="/app/material-components-web.min.js"></script>
    <script src="/app/app.js"></script>
    <script src="/star/star.js"></script>
</head>

<body>
    <header class="top-bar">
        <div class="top-bar-left">
            <img src="/favicon.png" alt="Logo" class="top-bar-icon">
            <h1 class="top-bar-title">题库查询</h1>
            <span class="top-bar-version">V1.3</span>
        </div>
        <div class="top-bar-right">
            <button class="top-bar-btn" id="star" title="收藏">
                <span class="material-icons">star</span>
            </button>
            <button class="top-bar-btn" id="themeToggle" title="切换主题">
                <span class="material-icons" id="themeIcon">dark_mode</span>
            </button>
            <button class="top-bar-btn" id="calculatorBtn" title="计算器">
                <span class="material-icons">calculate</span>
            </button>
            <button class="top-bar-btn" title="GitHub" onclick="window.open('https://github.com/YuleBest/xiaomi-bl-unlock-helper', '_blank')">
                <span class="material-icons">code</span>
            </button>
        </div>
    </header>
    
    <div class="container mdc-typography">
        <div class="starred-header">
             <div class="starred-title">
                 <h2>收藏的题目</h2>
                 <span class="starred-count" id="starredCount">0 道题目</span>
             </div>
             <div class="starred-actions">
                 <button class="back-btn" id="backBtn">
                     <span class="material-icons">arrow_back</span>
                     <span>返回主页</span>
                 </button>
                 <button class="backup-btn" id="backupBtn">
                     <span class="material-icons">download</span>
                     <span>备份收藏</span>
                 </button>
                 <button class="import-btn" id="importBtn">
                     <span class="material-icons">upload</span>
                     <span>导入收藏</span>
                 </button>
                 <button class="clear-all-btn" id="clearAllBtn">
                     <span class="material-icons">clear_all</span>
                     <span>清空收藏</span>
                 </button>
             </div>
         </div>
         
         <!-- 提示信息 -->
         <div class="storage-notice">
             <div class="notice-icon">
                 <span class="material-icons">info</span>
             </div>
             <div class="notice-text">
                 <strong>数据存储提示：</strong>收藏的题目数据为本地存储，清除缓存会导致收藏的题目丢失，您可以备份或导入收藏的题目数据。
             </div>
         </div>
         
         <!-- 隐藏的文件输入 -->
         <input type="file" id="importFileInput" accept=".json" style="display: none;">
        
        <div class="starred-content">
            <div id="starredResults" class="starred-results"></div>
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-icon">
                    <span class="material-icons">star_border</span>
                </div>
                <h3>还没有收藏的题目</h3>
                <p>在主页浏览题目时，点击题目卡片右侧的收藏图标即可收藏题目</p>
            </div>
        </div>
    </div>
    <script>
        mdc.autoInit();
        
        // 收藏功能相关函数
        function getStarredQuestions() {
            const starred = localStorage.getItem('starredQuestions');
            return starred ? JSON.parse(starred) : {};
        }
        
        function saveStarredQuestions(starred) {
            localStorage.setItem('starredQuestions', JSON.stringify(starred));
        }
        
        // 页面初始化
         document.addEventListener('DOMContentLoaded', function() {
             initializeTheme();
             loadStarredQuestions();
             initializeStarredPageEvents();
         });
          
         // 初始化主题
         function initializeTheme() {
             const savedTheme = localStorage.getItem('theme');
             const themeIcon = document.getElementById('themeIcon');
             
             if (savedTheme) {
                 setTheme(savedTheme);
             } else {
                 const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                 setTheme(prefersDark ? 'dark' : 'light');
             }
             
             // 主题切换按钮事件
             const themeToggle = document.getElementById('themeToggle');
             if (themeToggle) {
                 themeToggle.addEventListener('click', function() {
                     const currentTheme = document.documentElement.getAttribute('data-theme');
                     const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                     setTheme(newTheme);
                 });
             }
             
             function setTheme(theme) {
                 document.documentElement.setAttribute('data-theme', theme);
                 if (themeIcon) {
                     themeIcon.textContent = theme === 'dark' ? 'light_mode' : 'dark_mode';
                 }
                 localStorage.setItem('theme', theme);
             }
          }
          
          function loadStarredQuestions() {
              const starred = getStarredQuestions();
              const starredArray = Object.values(starred);
              
              updateStarredCount(starredArray.length);
              
              if (starredArray.length === 0) {
                  showEmptyState();
                  return;
              }
              
              // 按收藏时间倒序排列
              starredArray.sort((a, b) => new Date(b.starredAt) - new Date(a.starredAt));
              
              renderStarredResults(starredArray);
          }
          
          function renderStarredResults(questions) {
              const resultsDiv = document.getElementById('starredResults');
              const emptyState = document.getElementById('emptyState');
              
              resultsDiv.innerHTML = '';
              emptyState.style.display = 'none';
              
              const ul = document.createElement('ul');
              ul.className = 'mdc-list mdc-list--two-line';
              
              questions.forEach(item => {
                  const li = document.createElement('li');
                  li.className = 'mdc-list-item question-item';
                  
                  const primaryText = document.createElement('span');
                  primaryText.className = 'mdc-list-item__ripple';
                  li.appendChild(primaryText);
                  
                  const textContainer = document.createElement('span');
                  textContainer.className = 'mdc-list-item__text';
                  
                  const questionTitle = document.createElement('span');
                  questionTitle.className = 'mdc-list-item__primary-text question-title';
                  
                  const questionNumber = document.createElement('span');
                  questionNumber.className = 'question-number';
                  questionNumber.textContent = item.originalIndex;
                  
                  const questionText = document.createElement('span');
                  questionText.innerHTML = item.question;
                  
                  questionTitle.appendChild(questionNumber);
                  questionTitle.appendChild(questionText);
                  textContainer.appendChild(questionTitle);
                  
                  const optionsUl = document.createElement('ul');
                  optionsUl.className = 'options-list mdc-list-item__secondary-text';
                  
                  const sortedOptions = [...item.options].sort((a, b) => {
                      const aCorrect = a.is_correct === 'true';
                      const bCorrect = b.is_correct === 'true';
                      if (aCorrect && !bCorrect) return -1;
                      if (!aCorrect && bCorrect) return 1;
                      return 0;
                  });
                  
                  sortedOptions.forEach(opt => {
                      const optionLi = document.createElement('li');
                      optionLi.innerHTML = opt.option;
                      optionLi.className = opt.is_correct === 'true' ? 'correct' : 'incorrect';
                      optionsUl.appendChild(optionLi);
                  });
                  
                  textContainer.appendChild(optionsUl);
                  
                  // 添加取消收藏按钮
                  const unstarButton = document.createElement('button');
                  unstarButton.className = 'star-btn starred';
                  unstarButton.title = '取消收藏';
                  unstarButton.innerHTML = '<span class="material-icons">star</span>';
                  
                  unstarButton.addEventListener('click', (e) => {
                      e.stopPropagation();
                      removeFromStarred(item.originalIndex);
                  });
                  
                  li.appendChild(textContainer);
                  li.appendChild(unstarButton);
                  ul.appendChild(li);
              });
              
              resultsDiv.appendChild(ul);
          }
          
          function removeFromStarred(questionId) {
              const starred = getStarredQuestions();
              delete starred[questionId];
              saveStarredQuestions(starred);
              loadStarredQuestions();
          }
          
          function updateStarredCount(count) {
              const countElement = document.getElementById('starredCount');
              if (countElement) {
                  countElement.textContent = `${count} 道题目`;
              }
          }
          
          function showEmptyState() {
              const resultsDiv = document.getElementById('starredResults');
              const emptyState = document.getElementById('emptyState');
              
              resultsDiv.innerHTML = '';
              emptyState.style.display = 'block';
          }
          
          function initializeStarredPageEvents() {
            // 返回主页按钮
            const backBtn = document.getElementById('backBtn');
            const backToHomeBtn = document.getElementById('backToHomeBtn');
            
            [backBtn, backToHomeBtn].forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', function() {
                        window.location.href = '/';
                    });
                }
            });
            
            // 清空收藏按钮
            const clearAllBtn = document.getElementById('clearAllBtn');
            if (clearAllBtn) {
                clearAllBtn.addEventListener('click', function() {
                    if (confirm('确定要清空所有收藏的题目吗？此操作不可撤销。')) {
                        localStorage.removeItem('starredQuestions');
                        loadStarredQuestions();
                    }
                });
            }
            
            // 备份收藏按钮
            const backupBtn = document.getElementById('backupBtn');
            if (backupBtn) {
                backupBtn.addEventListener('click', function() {
                    exportStarredQuestions();
                });
            }
            
            // 导入收藏按钮
            const importBtn = document.getElementById('importBtn');
            const importFileInput = document.getElementById('importFileInput');
            if (importBtn && importFileInput) {
                importBtn.addEventListener('click', function() {
                    importFileInput.click();
                });
                
                importFileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        importStarredQuestions(file);
                    }
                });
            }
        }
        
        // 导出收藏的题目
        function exportStarredQuestions() {
            const starredQuestions = getStarredQuestions();
            const questionCount = Object.keys(starredQuestions).length;
            
            if (questionCount === 0) {
                alert('没有收藏的题目可以备份');
                return;
            }
            
            const exportData = {
                exportTime: new Date().toISOString(),
                version: '1.0',
                count: questionCount,
                data: starredQuestions
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `starred_questions_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`备份成功！已导出 ${questionCount} 道收藏的题目`);
        }
        
        // 导入收藏的题目
        function importStarredQuestions(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // 检查文件格式
                    if (!importedData.data || typeof importedData.data !== 'object') {
                        throw new Error('文件格式不正确');
                    }
                    
                    const existingQuestions = getStarredQuestions();
                    const existingIds = new Set(Object.keys(existingQuestions));
                    
                    let newCount = 0;
                    let skipCount = 0;
                    
                    // 合并数据
                    Object.keys(importedData.data).forEach(questionId => {
                        if (!existingIds.has(questionId)) {
                            existingQuestions[questionId] = importedData.data[questionId];
                            newCount++;
                        } else {
                            skipCount++;
                        }
                    });
                    
                    saveStarredQuestions(existingQuestions);
                    loadStarredQuestions();
                    
                    alert(`导入成功！新增 ${newCount} 道题目，跳过 ${skipCount} 道重复题目。`);
                } catch (error) {
                    console.error('导入错误:', error);
                    alert('导入失败：文件格式不正确或文件损坏');
                }
                
                // 清空文件输入
                document.getElementById('importFileInput').value = '';
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>